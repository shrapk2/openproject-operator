# OpenProject Operator

The **OpenProject Operator** automates two main workflows in your Kubernetes cluster:

1. **Ticket Scheduling**  
   Create and manage recurring work packages (tickets) in an OpenProject server via Kubernetes Custom Resources.

2. **Cloud & Kubernetes Inventory**  
   Scan AWS and/or Kubernetes resources on a schedule, generate inventory reports, and optionally embed summaries into work packages.

---

## ‚ú® Features

- **Declarative ticket creation** using the `WorkPackages` CRD
- **Scheduled ticket generation** via cron expressions
- **Dynamic OpenProject server configuration** via `ServerConfig`
- **Intelligent status tracking** with `lastRunTime`, `nextRunTime`, and ticket IDs
- **AWS inventory scanning** for EC2, RDS, ELBV2, S3, EIP, ECR, NAT Gateways, Internet Gateways
- **Kubernetes inventory scanning** for pods and container images (local or remote clusters)
- **Automatic `CloudInventoryReport` CRDs** containing raw and summarized inventory data
- **On-demand inventory integration** in ticket descriptions when `WorkPackages.spec.inventoryRef` is set
- **Helm-installable** with pre-install CRD checks and customizable values

---

## üì¶ CRDs

This operator defines four CRDs:

1. `ServerConfig`  
   Stores API endpoint and credentials (API key) for your OpenProject server.

2. `WorkPackages`  
   Defines a scheduled ticket: subject, description, project/type IDs, cron schedule, optional parent (`epicID`), and optional inventory integration.

3. `CloudInventory`  
   Specifies an inventory scan:

   - `spec.mode`: `"aws"` or `"kubernetes"`
   - AWS options (`credentialsSecretRef`, `assumeRoleARN`, `resources`, `region`, `tagFilter`)
   - Kubernetes options (`namespaces`, `labelSelector`, `kubeconfigSecretRef`)

4. `CloudInventoryReport`  
   Auto-generated by the operator: contains timestamp, raw item lists, and summary counts for the requested inventory.

---

## üöÄ Getting Started

### Prerequisites

- Go 1.22+
- Docker 20.10+
- Kubernetes 1.24+
- `kubectl` and `helm` installed and configured

---

### Build and Push Docker Image

```sh
make docker-build docker-push IMG=shrapk2/openproject-operator:<tag>
```

### Install CRDs

```sh
make install
```

### Deploy the Operator

```sh
make deploy IMG=shrapk2/openproject-operator:<tag>
```

---

## üß† Helm Chart Deployment

The Helm charts are located in the `charts/` directory. You can install the operator and its required resources using:

```sh
helm repo add openproject-operator https://shrapk2.github.io/openproject-operator
helm repo update
helm search repo openproject-operator
#
helm install openproject-operator openproject-operator/openproject-operator --set image.repository=shrapk2/openproject-operator --set image.tag=<tag>
```

Then deploy one or more `WorkPackages` using the companion Helm chart:

```sh
helm install dev-server-config openproject-operator/openproject-serverconfig
helm install daily-workpackage-1 openproject-operator/openproject-workpackage
```

### CRD Check Hook

The Helm chart includes a pre-install hook to validate the presence of required CRDs (`ServerConfig`, `WorkPackages`) and will fail gracefully with an appropriate message if they are missing.

---

## üêõ Debugging & Logging

Set the following environment variable to enable verbose debugging:

```sh
DEBUG=true make run
```

In production, default logs are scoped with minimal context:

- Name
- Schedule
- Status

When `DEBUG` is enabled, the logs include payloads, headers, and reconciliation internals.

---

## üßº Uninstalling

```sh
make undeploy
make uninstall
```

Or via Helm:

```sh
helm uninstall openproject-operator
```

---

## üí° Contributing

Feature requests, PRs, and feedback are welcome! Please:

- Fork the repository
- Create a feature branch
- Run `make test` and `make vet`
- Submit a PR with context

---

## üìÑ License

Apache 2.0 ‚Äî see [LICENSE](./LICENSE)

---

## üìö Resources

- [Kubebuilder Book](https://book.kubebuilder.io/)
- [OpenProject REST API](https://docs.openproject.org/api/)
- [Operator SDK Documentation](https://sdk.operatorframework.io/)
